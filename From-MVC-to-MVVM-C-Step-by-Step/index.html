<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="en">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="iOS,MVC,MVVM,RxSwift,Coordinator,Design Pattern,Architecture Pattern,ViewModel," />










<meta name="description" content="Table of ContentsPreface  In this article, I will share my experience how to refactor the codebase from MVC to MVVM-C. I will start with a simple example application, and do the refactoring step by st">
<meta name="keywords" content="iOS,MVC,MVVM,RxSwift,Coordinator,Design Pattern,Architecture Pattern,ViewModel">
<meta property="og:type" content="article">
<meta property="og:title" content="From MVC to MVVM-C, Step by Step, Part I">
<meta property="og:url" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/index.html">
<meta property="og:site_name" content="Qubo Qin&#39;s Blog">
<meta property="og:description" content="Table of ContentsPreface  In this article, I will share my experience how to refactor the codebase from MVC to MVVM-C. I will start with a simple example application, and do the refactoring step by st">
<meta property="og:locale" content="en">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Price_View_Controller.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Swipe_to_Add_Favorite.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/My_Favorites_ViewController.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Swipe_to_Remove_from_Favorite_List.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Expand_ViewController.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Settings_ViewController.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Mockaroo.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Easy_Mock.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/The_Whole_Picture_of_the_UI.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Update_Cycle.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Transitioning_API.jpg">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Networking.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Data_Filter.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Methods_For_Information_Flow.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/RxSwift_Chain.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/RxSwift_Chain_2.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/RxSwift_Chain_3.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/ViewModel2.png">
<meta property="og:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Coordinator_%20Asynchronous_Call.png">
<meta property="og:updated_time" content="2018-09-27T00:30:26.290Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="From MVC to MVVM-C, Step by Step, Part I">
<meta name="twitter:description" content="Table of ContentsPreface  In this article, I will share my experience how to refactor the codebase from MVC to MVVM-C. I will start with a simple example application, and do the refactoring step by st">
<meta name="twitter:image" content="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/Price_View_Controller.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: 'Author'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/"/>





  <title>From MVC to MVVM-C, Step by Step, Part I | Qubo Qin's Blog</title>
  








</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="en">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Qubo Qin's Blog</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            Home
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            Categories
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            Archives
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://blog.magicefire.com/From-MVC-to-MVVM-C-Step-by-Step/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Qubo Qin">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Qubo Qin's Blog">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">From MVC to MVVM-C, Step by Step, Part I</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">Posted on</span>
              
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2018-08-23T12:30:22-07:00">
                2018-08-23
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">In</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Software-Architecture/" itemprop="url" rel="index">
                    <span itemprop="name">Software Architecture</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Table-of-Contents"><a href="#Table-of-Contents" class="headerlink" title="Table of Contents"></a>Table of Contents</h1><h2 id="Preface"><a href="#Preface" class="headerlink" title="Preface"></a>Preface</h2><p>  In this article, I will share my experience how to refactor the codebase from MVC to MVVM-C. I will start with a simple example application, and do the refactoring step by step slowly to show you every key points of architecture pattern in iOS development.</p>
<h2 id="Introduction-of-the-Demo-application"><a href="#Introduction-of-the-Demo-application" class="headerlink" title="Introduction of the Demo application"></a>Introduction of the Demo application</h2><p>  I will create an application which is cloned from some applications about cryptocurrency market on Appstore. The application doesn‚Äôt touch any buying or selling actions, it just show the marketing data from Open APIs, so you don‚Äôt worry about your wallet :)</p>
<p>  It is a very simple example, including only four main pages.</p>
<p>  The ‚ÄúPrices‚Äù show the current marketing prices, you can input the name of cryptocurrency which you interested in to filter the table list, and you can also sort the order by click the name, price and change label on the section header.</p>
<p>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/Price_View_Controller.png" width="50%" margin-left="auto" margin-right="auto"></p>
<p>  Swipe the table items in the price list, you can save these items into your favorite list. In the ‚ÄúMy Favorites‚Äù, you can swipe the item to remove it from your favorite list.</p>
  <div display="flex"><br>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/Swipe_to_Add_Favorite.png" width="30%" padding="5px"><br><br>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/My_Favorites_ViewController.png" width="30%" padding="5px"><br><br>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/Swipe_to_Remove_from_Favorite_List.png" width="30%" padding="5px"><br>  </div>

<p>  Click the item in the Price list, the item will be expanded to show a kline diagram.</p>
<p>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/Expand_ViewController.png" width="50%" margin-left="auto" margin-right="auto"></p>
<p>  At the right cover of the price page, there is a setting button which will pop a setting page to let you choice the data source of the kline. You have two options, one is from Huobi, the other is from Crypto Compare. You can also click the switch to save your favorites then they will be reloaded when you open the application next time.</p>
<p>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/Settings_ViewController.png" width="50%" margin-left="auto" margin-right="auto"></p>
<p>  That‚Äôs all. Though it is an really simple example, it still cover lots of knowledges in iOS development. But this article only focuses on some topics listed below:</p>
<ol>
<li>the architecture patterns: <br><br>From MVC, MVVM, MVVM+RxSwift to MVVM+RxSwift+Coordinator, so many acronyms, which architecture is the best? I think that none of them is the ‚ÄúBest‚Äù one. There is <strong> ‚ÄúNo Silver Bullet‚Äù</strong>. Each one can suit better a specific scenario. But we must follow some principles. In this article, I will share my experience and list the pros and the cons of each pattern, and talk about how to make choice when I design an application.</li>
<li>how to implement the user interface: <br><br>The first thing in writing an application is implementing the user interface. But sometime we need essential data to help us to design the UI. Where these data come from? Do we need to write the networking layer first and fetch data from the backend? Or just grab some data through branch of http requests and save these data as an asset file in JSON format? <br><br><br>But there is another good idea that we can use some data mock platforms to generate these data automatically.<ul>
<li><a href="https://mockaroo.com/" target="_blank" rel="noopener">Mockaroo</a> <br><br><img src="/From-MVC-to-MVVM-C-Step-by-Step/Mockaroo.png" width="50%" margin-left="auto" margin-right="auto"></li>
<li><a href="https://github.com/easy-mock/easy-mock" target="_blank" rel="noopener">Easy Mock(Â§ßÊêúËΩ¶)</a> <br><br><img src="/From-MVC-to-MVVM-C-Step-by-Step/Easy_Mock.png" width="50%" margin-left="auto" margin-right="auto"> <br><br>This is also an open source solution, you can build your own data mock platform on your computer.</li>
</ul>
</li>
<li>how to build a networking layer <br><br>After we finish our UI design, we must create service modules to connect the real world to get the data and present these data onto our UI components. If you are lazy, you can import a third party solution, the popular one is <a href="https://github.com/Alamofire/Alamofire" target="_blank" rel="noopener">Alamofire</a>. It is very easy to use and very powerful. But in this article I will build my networking layer from scratch. You can reference this paper <a href="https://medium.com/flawless-app-stories/writing-network-layer-in-swift-protocol-oriented-approach-4fa40ef1f908" target="_blank" rel="noopener">Writing a Network Layer in Swift: Protocol-Oriented Approach</a>. <a href="https://medium.com/@malcolmcollin" target="_blank" rel="noopener">Malcolm Kumwenda</a> is a good guy to help you create you own networking layer step by step. <br> <br><br>Why do I need to write networking layer by myself? One principle is we must implement the core module by ourselves and if these module are not very difficult to implement. Be careful to depend on a third party source, particularly when lots of other modules depend on it. You will take high risk to rely on these third party solutions.  </li>
<li>how to test your modules. <br><br>The deliver quality is based on how we dedicate on testing. And all outputs of refactoring the architecture are let us more easy to test our code. ViewModel separated from ViewController is more helpful to test the business logic and the presentational logic.</li>
<li>immigrate from procedural programming to functional Reactive Programming <br><br>Immigrating from procedural programming to declarative programming is just like people who immigrate to a new country where the language is totally different.<br>the life is hard, but it is still going on. If you estimate that the business logic and the state of your application will become more complicated as time goes by.</li>
</ol>
<blockquote>
<p>The functional programming paradigm was explicitly created to support a pure functional approach to problem solving. Functional programming is a form of declarative programming. In contrast, most mainstream languages, including object-oriented programming (OOP) languages such as C#, C++, and Java, were designed to primarily support imperative (procedural) programming.</p>
</blockquote>
<h2 id="Design-Our-UI"><a href="#Design-Our-UI" class="headerlink" title="Design Our UI"></a>Design Our UI</h2><p>Understanding how and when a view updates requires a deeper understanding of the  UIKit framework. This article focuses on the architecture patterns, so we will not talk more about the UI staffs. But the topics I discuss below are very important to you to build an application as quickly as possible.</p>
<h4 id="Storyboard-or-Programmatic-is-a-problem"><a href="#Storyboard-or-Programmatic-is-a-problem" class="headerlink" title="Storyboard or Programmatic is a problem"></a>Storyboard or Programmatic is a problem</h4><p>  Here is the whole picture of our pages in the storyboard.</p>
<p>  <img src="/From-MVC-to-MVVM-C-Step-by-Step/The_Whole_Picture_of_the_UI.png" width="90%" margin-left="auto" margin-right="auto"></p>
<p>  There are still lots of debates about whether to use storyboard or write UI programmatically. You can find a lot of articles to summarize the pros and cons on both sides(<a href="https://blog.bobthedeveloper.io/why-i-dont-use-storyboard-fe14a1a99f58" target="_blank" rel="noopener">Why I Don‚Äôt Use Storyboard</a> and <a href="https://medium.com/@chan.henryk/storyboard-vs-programmatically-in-swift-9a65ff6aaeae" target="_blank" rel="noopener">Storyboard vs Programmatically in Swift</a>). These are guidelines when I need to make a choice at the crossroads.</p>
<table>
<thead>
<tr>
<th>Storyboard</th>
<th>Programmatic</th>
</tr>
</thead>
<tbody>
<tr>
<td>Ease to use</td>
<td>Reusability</td>
</tr>
<tr>
<td>Visualization</td>
<td>Merge Conflict</td>
</tr>
</tbody>
</table>
<p>  In a big project, the choice is depended on your team and the consensus made in your team. I prefer using storyboard to create static view objects and doing it programmatically when I create visual objects dynamically.</p>
<blockquote>
<p>When I teach, I don‚Äôt wanna make my audience fall asleep. So, why not make it a little more interesting since seeing is believing.ü§î</p>
</blockquote>
<p>  Because this is a demo application, and the UI is very simple, so using storyboard is good choice.</p>
<h4 id="How-many-view-controllers-do-we-need"><a href="#How-many-view-controllers-do-we-need" class="headerlink" title="How many view controllers do we need?"></a>How many view controllers do we need?</h4><p>  UX/UI designer create the wireframes by using <strong>Sketch</strong>. Sometimes we just map the pages in the sketch file to view controllers, they are almost one-on-one mapping. But be careful! Before apply other architecture paradigm, we start from MVC, and view controllers in MVC mode are so heavy, so discuss the features with your UX/UI designers or product designers first if you don‚Äôt want to mess up. Sometimes we must separate some of features in one page and move them into other view controllers. These view controllers are embedded in the ‚Äúhost‚Äù view controller as child view controllers. In our demo application, when we click on the item in the tableview, the cell will be expanded and show the kline of selected cryptocurrency, the expanded view in the cell view need a child view controller to coordinate the kline data service and the view who show the kline. So I  dynamically create a view controller named ‚ÄúExpandViewcontroller‚Äù as a child view controller embedded in ‚ÄúCoinListViewController‚Äù.</p>
<p>  Expand the cell view and add the ‚ÄúExpandViewcontroller‚Äù as a child view controller,<br>  <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">expandViewController = <span class="type">UIStoryboard</span>(name: <span class="string">"Main"</span>, bundle: <span class="literal">nil</span>).instantiateViewController(withIdentifier: <span class="string">"ExpandViewController"</span>) <span class="keyword">as</span>! <span class="type">ExpandViewController</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.addChildViewController(expandViewController)</span><br><span class="line">cell.expandView.addSubview(expandViewController.view)</span><br><span class="line"></span><br><span class="line">expandViewController.view.translatesAutoresizingMaskIntoConstraints = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"><span class="type">NSLayoutConstraint</span>.activate([</span><br><span class="line">    expandViewController.view.leadingAnchor.constraint(equalTo: cell.expandView.leadingAnchor),</span><br><span class="line">    expandViewController.view.trailingAnchor.constraint(equalTo: cell.expandView.trailingAnchor),</span><br><span class="line">    expandViewController.view.topAnchor.constraint(equalTo: cell.expandView.topAnchor),</span><br><span class="line">    expandViewController.view.bottomAnchor.constraint(equalTo: cell.expandView.bottomAnchor)</span><br><span class="line">    ])</span><br><span class="line"></span><br><span class="line">expandViewController.didMove(toParentViewController: <span class="keyword">self</span>)</span><br></pre></td></tr></table></figure></p>
<p>  Fold the cell view when we click the cell again,<br>  <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">expandViewController?.view.removeFromSuperview()</span><br><span class="line">expandViewController?.removeFromParentViewController()</span><br><span class="line">expandViewController = <span class="literal">nil</span></span><br></pre></td></tr></table></figure></p>
<h4 id="AutoLayout-and-constraint"><a href="#AutoLayout-and-constraint" class="headerlink" title="AutoLayout and constraint"></a>AutoLayout and constraint</h4><p>  Being familiar with UIKit is very important for developing your user interface. And you must be prepare to move beyond the basics, and dive into the UI framework. When you do start writing iOS apps, you‚Äôll have a solid and rigorous<br>  understanding of what you are doing and where you are heading.</p>
<p>  There are three stages before views can be displayed on the screen. The first step is ‚Äúupdating constrains‚Äù, which is form subviews to their superviews(bottom-up). It will prepare the information needed for the second step called ‚Äúlayout‚Äù. In this step, frames(centers and bounds) of views will be set depending on the constrain system. Finally the ‚Äúdisplay‚Äù pass renders the views on the screen.</p>
<p>  Before you take control of layout, you need to know how to trigger the override functions in these three steps, and when to trigger these functions. The table below lists all relative functions in these steps.</p>
<table>
<thead>
<tr>
<th>Method purposes</th>
<th>Constraints</th>
<th>Layout</th>
<th>Display</th>
</tr>
</thead>
<tbody>
<tr>
<td>Implement updates (override, don‚Äôt call explicitly)</td>
<td>updateConstraints</td>
<td>layoutSubviews</td>
<td>draw</td>
</tr>
<tr>
<td>Explicitly mark view as needing update on next update cycle</td>
<td>setNeedsUpdateConstraints invalidateIntrinsicContentSize</td>
<td>setNeedsLayout</td>
<td>setNeedsDisplay</td>
</tr>
<tr>
<td>Update immediately if view is marked as ‚Äúdirty‚Äù</td>
<td>updateConstraintsIfNeeded</td>
<td></td>
<td>layoutIfNeeded</td>
</tr>
<tr>
<td>Actions that implicitly cause views to be updated</td>
<td>Activate/deactivate constraints<br>Change constraint‚Äôs value or priority<br>Remove view from view hierarchy</td>
<td>addSubview<br>Resizing a view setFrame that changes a view‚Äôs bounds (not just a translation)<br>User scrolls a UIScrollView<br>User rotates device</td>
<td>Changes in a view‚Äôs bounds</td>
</tr>
</tbody>
</table>
<h5 id="A-good-example-of-changing-the-local-constraints"><a href="#A-good-example-of-changing-the-local-constraints" class="headerlink" title="A good example of changing the local constraints"></a>A good example of changing the local constraints</h5><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a new property to hold the aspect ratio constraint of an imageView</span></span><br><span class="line"><span class="keyword">fileprivate</span> <span class="keyword">var</span> aspectRatioConstraint:<span class="type">NSLayoutConstraint</span>?</span><br><span class="line"></span><br><span class="line"><span class="comment">// Override the updateConstraints function to recreate the aspect ratio constraint depending on the image width and height</span></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">updateConstraints</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.updateConstraints()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> aspectRatio: <span class="type">CGFloat</span> = <span class="number">1</span></span><br><span class="line">  <span class="keyword">if</span> <span class="keyword">let</span> image = image &#123;</span><br><span class="line">    aspectRatio = image.size.width / image.size.height</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// setting the isActive of a constraint to false will make this constraint be nil, so you need to create a new one</span></span><br><span class="line">  aspectRatioConstraint?.isActive = <span class="literal">false</span></span><br><span class="line">  aspectRatioConstraint =</span><br><span class="line">      imageView.widthAnchor.constraint(</span><br><span class="line">        equalTo: imageView.heightAnchor,</span><br><span class="line">        multiplier: aspectRatio)</span><br><span class="line">  aspectRatioConstraint?.isActive = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Change the image property declaration in order to invalidate the constraints and trigger the autolayout process again:</span></span><br><span class="line"><span class="keyword">var</span> image: <span class="type">UIImage</span>? &#123;</span><br><span class="line">  <span class="keyword">didSet</span> &#123;</span><br><span class="line">    imageView.image = image</span><br><span class="line">    setNeedsUpdateConstraints()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="Change-constraints-with-animations"><a href="#Change-constraints-with-animations" class="headerlink" title="Change constraints with animations"></a>Change constraints with animations</h5><p>If you want to replace the default behaviors of constraints animation, you must call the <em>layoutIfNeeded</em> function in the animation block, otherwise the change of the constraint will be executed in the update cycle of the run loop, so the animation block you defined will be useless.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">collapseHeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">UIView</span>.animate(withDuration: <span class="number">1.2</span>, animations: &#123;</span><br><span class="line">        <span class="keyword">self</span>.headerHeightConstraint.constant = <span class="keyword">self</span>.minHeaderHeight</span><br><span class="line">        <span class="keyword">self</span>.view.layoutIfNeeded()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">expandHeader</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="type">UIView</span>.animate(withDuration: <span class="number">0.2</span>, animations: &#123;</span><br><span class="line">        <span class="keyword">self</span>.headerHeightConstraint.constant = <span class="keyword">self</span>.maxHeaderHeight</span><br><span class="line">        <span class="keyword">self</span>.view.layoutIfNeeded()</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the <em>updateConstraints()</em> function, you can‚Äôt invalidate any constraints, otherwise you will get a crash because your program has already been in the layout cycle.<br><img src="/From-MVC-to-MVVM-C-Step-by-Step/Update_Cycle.png" width="80%" margin-left="auto" margin-right="auto"><br><br>You can change the properties which are relative with the constraints, then invalidate constraints and trigger the layout process in the event process stage of the main run loop, then the system will call the callback function <em>updateConstraints</em> you override in the <strong> <em>update cycle</em> </strong> . In this function, you can change/remove/add constraints which depending on the properties changing before. This guideline can also apply to the process of layout and display.</p>
<p>There are some scenarios about how to fine-tune the frames of your views by overriding the <em>layoutSubviews</em> function. The first one is not necessary, because you can add a constraint, but it is an example.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">- layoutSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [super layoutSubviews];</span><br><span class="line">    if (self.subviews[0].frame.size.width &lt;= MINIMUM_WIDTH) &#123;</span><br><span class="line">        [self removeSubviewConstraints];</span><br><span class="line">        self.layoutRows += 1;</span><br><span class="line">        [super layoutSubviews];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">- updateConstraints</span><br><span class="line">&#123;</span><br><span class="line">    // add constraints depended on self.layoutRows...</span><br><span class="line">    [super updateConstraints];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p>There is a trick. Because the layout process is top-down, you can get the frame of the current view before you call the super function <em>layoutSubviews</em>. After the super function <em>layoutSubviews</em> being called, the subviews of this view also get their frames, so you can get the sizes and positions of its‚Äô subviews. In this case, we compare the width of the first subview, and change the <em>layoutRows</em> property, then call its‚Äô super <em>layoutSubviews</em> to fire the autolayout process from the updating constraints step again.<br><br>You can also subclass your first subview(in this case), and override the <em>layoutSubviews</em> function in its‚Äô subclass, and get its‚Äô frame like the next example which fine-tune the width of a multi-line label</p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@implementation MyLabel</span><br><span class="line">- (void)layoutSubviews</span><br><span class="line">&#123;</span><br><span class="line">    self.preferredMaxLayoutWidth = self.frame.size.width;</span><br><span class="line">    [super layoutSubviews];</span><br><span class="line">&#125;</span><br><span class="line">@end</span><br></pre></td></tr></table></figure>
<blockquote>
<p>Or you can make this adjustment at the view controller level, put this logic into the <em>viewDidLayoutSubviews</em> function. Because the autolayout process is finished,  so you must re-fire this process by calling <em>layoutIfNeeded</em></p>
</blockquote>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">- (void)viewDidLayoutSubviews</span><br><span class="line">&#123;</span><br><span class="line">    [super viewDidLayoutSubviews];</span><br><span class="line">    myLabel.preferredMaxLayoutWidth = myLabel.frame.size.width;</span><br><span class="line">    [self.view layoutIfNeeded];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="StackView-with-Fill-Distribution"><a href="#StackView-with-Fill-Distribution" class="headerlink" title="StackView with Fill Distribution"></a>StackView with Fill Distribution</h5><h4 id="Core-Animation‚Äôs-models-classes-and-blocks"><a href="#Core-Animation‚Äôs-models-classes-and-blocks" class="headerlink" title="Core Animation‚Äôs models, classes and blocks"></a>Core Animation‚Äôs models, classes and blocks</h4><p>  Animation in iOS is huge topic, but the animation process can be as simple as changing properties during a given time. It includes two main animation systems. One is based on ‚ÄúView Animation‚Äù, and the other is called ‚ÄúCore Animation‚Äù. I only list some key issues about Animation.</p>
<h5 id="View-Animation"><a href="#View-Animation" class="headerlink" title="View Animation"></a>View Animation</h5><p>  There are three stages for ‚ÄúView Animation‚Äù because of the historical evolution of iOS. I just give some snippet codes below for each of these stages.</p>
<ul>
<li><p>Begin and commit</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIView</span>.beginAnimations(<span class="literal">nil</span>, context: <span class="literal">nil</span>)</span><br><span class="line"><span class="type">UIView</span>.setAnimationDuration(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">self</span>.v.backgroundColor = .red</span><br><span class="line"><span class="type">UIView</span>.commitAnimations()</span><br></pre></td></tr></table></figure>
</li>
<li><p>Block-based animation</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">UIView</span>.animate(withDuration:<span class="number">1</span>) &#123;</span><br><span class="line">  <span class="keyword">self</span>.v.backgroundColor = .red</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Property animator</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> anim = <span class="type">UIViewPropertyAnimator</span>(duration: <span class="number">1</span>, curve: .linear) &#123;</span><br><span class="line">    <span class="keyword">self</span>.v.backgroundColor = .red</span><br><span class="line">&#125;</span><br><span class="line">anim.startAnimation()</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h5 id="Implicit-Layer-Animation"><a href="#Implicit-Layer-Animation" class="headerlink" title="Implicit Layer Animation"></a>Implicit Layer Animation</h5><p>  Before we jump to ‚ÄúCore Animation‚Äù, we also can change properties on CALayer. It is called ‚ÄúImplicit Layer Animation‚Äù. Just set layer properties, and your layers animate in the default way. You can not control the animation except you use a ‚ÄúCATransaction‚Äù with ‚ÄúImplicit Layer Animation‚Äù. And remember, there is always an implicit transaction surrounding your code, and you can operate on this implicit transaction without any begin and commit.</p>
  <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// can be omitted</span></span><br><span class="line"><span class="type">CATransaction</span>.begin()</span><br><span class="line"></span><br><span class="line"><span class="type">CATransaction</span>.setAnimationDuration(<span class="number">0.8</span>)</span><br><span class="line"><span class="keyword">self</span>.globalLabel.layer.transform = <span class="type">CATransform3DMakeRotation</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// can be omitted</span></span><br><span class="line"><span class="type">CATransaction</span>.commit()</span><br></pre></td></tr></table></figure>
<h5 id="Core-Animation"><a href="#Core-Animation" class="headerlink" title="Core Animation"></a>Core Animation</h5><p>  ‚ÄúCore Animation‚Äù is also called ‚ÄúExplicit Layer Animation‚Äù. To specify a property using a keyPath, we can create an CABasicAnimation object or its inheritance, then we add this object onto the layer of a view. There are two problems when we use ‚ÄúCore Animation‚Äù. One is setting a property on a layer will fire the ‚ÄúImplicit Layer Animation‚Äù, We can prevent this side effect by disabling actions:</p>
  <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">CATransaction</span>.begin()</span><br><span class="line"><span class="type">CATransaction</span>.setDisableActions(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> transformAnimation = <span class="type">CABasicAnimation</span>(keyPath: #keyPath(<span class="type">CALayer</span>.transform))</span><br><span class="line">transformAnimation.fromValue = <span class="type">CATransform3DMakeRotation</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">transformAnimation.toValue = <span class="type">CATransform3DMakeRotation</span>(<span class="type">CGFloat</span>(<span class="type">Double</span>.pi), <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">transformAnimation.duration = <span class="number">2</span></span><br><span class="line">transformAnimation.autoreverses = <span class="literal">true</span></span><br><span class="line">transformAnimation.repeatCount = .infinity</span><br><span class="line"></span><br><span class="line"><span class="type">CATransaction</span>.setCompletionBlock(&#123;</span><br><span class="line">  <span class="keyword">self</span>.globalLabel.layer.transform = <span class="type">CATransform3DMakeRotation</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">self</span>.globalLabel.layer.add(transformAnimation, forKey: #keyPath(<span class="type">CALayer</span>.transform))</span><br><span class="line"></span><br><span class="line"><span class="type">CATransaction</span>.commit()</span><br></pre></td></tr></table></figure>
<p>  The other problem is if we use ‚ÄúCore Animation‚Äù, the property will not change to the value when the animation is end, because ‚ÄúCore Animation‚Äù create a new layer to present the animation, called ‚Äúpresentation layer‚Äù. So we need it set the new value into the property of its ‚Äúmodel layer‚Äù in the completion block.</p>
<p>  If you use ‚ÄúImplicit Layer Animation‚Äù or ‚ÄúView Animation‚Äù, you don‚Äôt need to care about these problems, because the Animation framework will handle these for you. But when you use the ‚ÄúCore Animation‚Äù which is the fundamental underlying iOS animation technology, you get more powerful, so you need more responsibility.</p>
<h5 id="Transitions"><a href="#Transitions" class="headerlink" title="Transitions"></a>Transitions</h5><p>  Another concept called ‚ÄúTransitions‚Äù is very confused, if you are not a native English speaker. Usually we use ‚ÄúTransitions‚Äù in two situations. We can change the content of a view such as the image of a UIImageView using ‚Äútransition(with:duration:options:animations:completion:)‚Äù function:<br>  <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> opts : <span class="type">UIViewAnimationOptions</span> = .transitionFlipFromLeft</span><br><span class="line"><span class="type">UIView</span>.transition(with:<span class="keyword">self</span>.iv, duration: <span class="number">0.8</span>, options: opts, animations: &#123;</span><br><span class="line">    <span class="keyword">self</span>.iv.image = <span class="type">UIImage</span>(named:<span class="string">"Smiley"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>  Or we can replace the first view with the second view by using ‚Äútransition(from:to:duration:options:completion:)‚Äù function.<br>  <figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">let</span> lab2 = <span class="type">UILabel</span>(frame:<span class="keyword">self</span>.lab.frame)</span><br><span class="line">    lab2.text = <span class="keyword">self</span>.lab.text == <span class="string">"Hello"</span> ? <span class="string">"Howdy"</span> : <span class="string">"Hello"</span></span><br><span class="line">    lab2.sizeToFit()</span><br><span class="line">    <span class="type">UIView</span>.transition(from:<span class="keyword">self</span>.lab, to: lab2,</span><br><span class="line">        duration: <span class="number">0.8</span>, options: .transitionFlipFromLeft) &#123; <span class="number">_</span> <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">self</span>.lab = lab2</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="Custom-UIViewController-Transitions"><a href="#Custom-UIViewController-Transitions" class="headerlink" title="Custom UIViewController Transitions"></a>Custom UIViewController Transitions</h4><p>The transitioning API includes several components which conform a collection of protocols. The diagram below shows these relative components:</p>
<p><img src="/From-MVC-to-MVVM-C-Step-by-Step/Transitioning_API.jpg" width="80%" margin-left="auto" margin-right="auto"><br></p>
<p>Here is the 7 steps involved in a presentation transition:</p>
<ol>
<li><p>Before You trigger the transition either programmatically or via a segue, you need to set the transitioningDelegate property in your ‚Äúto‚Äù view controller. In this case, the transitioningDelegate is the ‚Äúfrom‚Äù view controller. The ‚Äúfrom‚Äù view controller in here is also the <strong> presenting </strong> view controller. When you trigger the transition via a segue, the override function <em>prepare(for:</em>)_ in the presenting view controller will be called, in this function, you can get the ‚Äúto‚Äù view controller(also called ‚Äú<strong> presented </strong>‚Äú) form the segue destination. Then you can set the transitioningDelegate property of the destination to itself.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="keyword">for</span> segue: UIStoryboardSegue, sender: Any?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.prepare(<span class="keyword">for</span>: segue, sender: sender)</span><br><span class="line">    segue.destination.transitioningDelegate = <span class="keyword">self</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> navigationController = segue.destination <span class="keyword">as</span>? <span class="type">SettingsNavigationController</span>,</span><br><span class="line">    <span class="keyword">let</span> settingsViewController = navigationController.viewControllers.first <span class="keyword">as</span>? <span class="type">SettingsViewController</span> &#123;</span><br><span class="line">      settingsViewController.delegate = <span class="keyword">self</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>UIKit asks the ‚Äúpresented‚Äù view controller (the view controller to be shown) for its transitioning delegate. If it doesn‚Äôt have one, UIKIt uses the standard, built-in transition. In here the delegate is the presenting view controller. The transition delegate conforms two methods of <strong> UIViewControllerTransitioningDelegate protocol </strong>. One is for presenting, the other is for dismissing.</p>
</li>
<li>UIKit then asks the transitioning delegate for an animation controller via animationController(forPresented:presenting:source:). If this returns nil, the transition will use the default animation. The transition delegate create and return an animation controller who confirms the <strong> UIViewControllerAnimatedTransitioning protocol </strong></li>
<li>UIKit constructs the transitioning context. Be careful, if you want to see the presenting view controller behind the presented view controller, you need to set the presentation style to .overFullScreen or .overCurrentContext. If you set this property to .fullScreen, the view of the presenting view controller will be replaced</li>
<li>UIKit asks the animation controller for the duration of its animation by calling transitionDuration(using:).</li>
<li>UIKit invokes animateTransition(using:) on the the animation controller to perform the animation for the transition.</li>
<li>Finally, the animation controller calls completeTransition(_:) on the transitioning context to indicate that the animation is complete.</li>
</ol>
<p>And the steps for a dismissing transition are nearly identical.<br>When you tigger the reserves process, UIKit asks the transitioning delegate for an animation controller animationController(forDismissed dismissed:), then repeat the steps from 4 to 7.</p>
<p>Here is the animation controller code who play the animation role:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">PresentTransitionController</span>: <span class="title">NSObject</span>, <span class="title">UIViewControllerAnimatedTransitioning</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">transitionDuration</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning?)</span></span> -&gt; <span class="type">TimeInterval</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0.6</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">animateTransition</span><span class="params">(using transitionContext: UIViewControllerContextTransitioning)</span></span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> fromViewController = transitionContext.viewController(forKey: .from)!</span><br><span class="line">        <span class="keyword">let</span> toViewController = transitionContext.viewController(forKey: .to)!</span><br><span class="line">        <span class="keyword">let</span> containerView = transitionContext.containerView</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> screenBounds = <span class="type">UIScreen</span>.main.bounds</span><br><span class="line">        <span class="keyword">let</span> topOffset: <span class="type">CGFloat</span> = <span class="number">160.0</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">var</span> finalFrame = transitionContext.finalFrame(<span class="keyword">for</span>: toViewController)</span><br><span class="line">        finalFrame.origin.y += topOffset</span><br><span class="line">        finalFrame.size.height -= topOffset</span><br><span class="line"></span><br><span class="line">        toViewController.view.frame = <span class="type">CGRect</span>(x: <span class="number">0.0</span>, y: screenBounds.size.height,</span><br><span class="line">                                             width: finalFrame.size.width,</span><br><span class="line">                                             height: finalFrame.size.height)</span><br><span class="line">        containerView.addSubview(toViewController.view)</span><br><span class="line"></span><br><span class="line">        <span class="type">UIView</span>.animate(withDuration: transitionDuration(using: transitionContext), delay: <span class="number">0.0</span>, usingSpringWithDamping: <span class="number">0.8</span>, initialSpringVelocity: <span class="number">1.0</span>, options: .curveEaseOut, animations: &#123;</span><br><span class="line">            toViewController.view.frame = finalFrame</span><br><span class="line">            fromViewController.view.alpha = <span class="number">0.3</span></span><br><span class="line">        &#125;) &#123; (finished) <span class="keyword">in</span></span><br><span class="line">            transitionContext.completeTransition(finished)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Add-Gesture-On-the-Section-header"><a href="#Add-Gesture-On-the-Section-header" class="headerlink" title="Add Gesture On the Section header"></a>Add Gesture On the Section header</h4><h2 id="Connect-with-internet"><a href="#Connect-with-internet" class="headerlink" title="Connect with internet"></a>Connect with internet</h2><p>We already have got the ‚ÄúViews‚Äù in MVC pattern, it is time to build the ‚ÄúModels‚Äù and create networking service to connect with our backend. There are lots of approaches to build the ‚ÄúModels‚Äù and networking service.</p>
<ol>
<li><p>The most formal way is introducing some mocks and stubs before creating real data models and connecting the endpoints. The frontend developing will not depend on the progress of the backend developing. As I mentioned before you can use the data mock platform to mock the data we need, some of these platform are open source. You can setup your own data mock platform on your laptop, and you also can use their online service to create data, then download and save to a JSON file as a resource embedded into your application bundle. The other benefit is you can use these mock data to test your business logics and application logics. You will not stuck in debugging with backend engineers and complain each other, and the testers who get theirs test sets can help you test your application and business logics.</p>
</li>
<li><p>If the backend service is ready and stable. You can skip the step to build the mock data and stubs. Importing a third party module is also a good choice. <a href="https://github.com/Alamofire/Alamofire" target="_blank" rel="noopener">Alamofire</a> is one of the famous open sources. Using a heavy library sometimes you must be careful, if you don‚Äôt want to relay on this one.</p>
</li>
<li><p>There are an assumption that building a networking framework is a big challenge. Implementing the basic feature I think is not difficult, you can reference this topic <a href="https://medium.com/flawless-app-stories/writing-network-layer-in-swift-protocol-oriented-approach-4fa40ef1f908" target="_blank" rel="noopener">‚ÄúWriting a Network Layer in Swift: Protocol-Oriented Approach<br>‚Äú</a> from Malcolm Kumwenda. This guy write a good article to teach you how to build your own networking layer step by step.</p>
</li>
</ol>
<p>First I wrote a http request using the native API <strong><em>URLSession</em></strong>, extend each model with a JSON initializer, handle the nested objects. When I get the data from a http request, I map the JSON format into a corresponding object.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Ticket</span> </span>&#123;</span><br><span class="line">    <span class="keyword">init</span>?(from json: [<span class="type">String</span>: <span class="type">Any</span>]) &#123;</span><br><span class="line">        <span class="keyword">guard</span></span><br><span class="line">            <span class="keyword">let</span> id = json[<span class="string">"id"</span>] <span class="keyword">as</span>? <span class="type">UInt</span>,</span><br><span class="line">            <span class="keyword">let</span> name = json[<span class="string">"name"</span>] <span class="keyword">as</span>? <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">let</span> symbol = json[<span class="string">"symbol"</span>] <span class="keyword">as</span>? <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">let</span> website_slug = json[<span class="string">"website_slug"</span>] <span class="keyword">as</span>? <span class="type">String</span>,</span><br><span class="line">            <span class="keyword">let</span> rank = json[<span class="string">"rank"</span>] <span class="keyword">as</span>? <span class="type">UInt</span>,</span><br><span class="line">            <span class="keyword">let</span> circulating_supply = json[<span class="string">"circulating_supply"</span>] <span class="keyword">as</span>? <span class="type">Double</span>,</span><br><span class="line">            <span class="keyword">let</span> total_supply = json[<span class="string">"total_supply"</span>] <span class="keyword">as</span>? <span class="type">Double</span>,</span><br><span class="line">            <span class="keyword">let</span> max_supply = json[<span class="string">"max_supply"</span>] <span class="keyword">as</span>? <span class="type">Double</span>,</span><br><span class="line">            <span class="keyword">let</span> quotesDict = json[<span class="string">"quotes"</span>] <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>],</span><br><span class="line">            <span class="keyword">let</span> last_updated = json[<span class="string">"last_updated"</span>] <span class="keyword">as</span>? <span class="type">UInt64</span></span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">self</span>.<span class="keyword">init</span>(id: id,</span><br><span class="line">                  name: name,</span><br><span class="line">                  symbol: symbol,</span><br><span class="line">                  website_slug: website_slug,</span><br><span class="line">                  rank: rank,</span><br><span class="line">                  circulating_supply: circulating_supply,</span><br><span class="line">                  total_supply: total_supply,</span><br><span class="line">                  max_supply: max_supply,</span><br><span class="line">                  quotes: <span class="type">Dictionary</span>(uniqueKeysWithValues:</span><br><span class="line">                    quotesDict.<span class="built_in">map</span> &#123; key, value <span class="keyword">in</span></span><br><span class="line">                        <span class="keyword">let</span> (key, value) = (key, <span class="type">QUOTE</span>(from: (value <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>])!))</span><br><span class="line">                        <span class="keyword">return</span> (key, value!)</span><br><span class="line">                    &#125;</span><br><span class="line">                  ),</span><br><span class="line">                  last_updated: last_updated)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> url = <span class="type">URL</span>(string: <span class="string">"https://api.coinmarketcap.com/v2/ticker/"</span>)!</span><br><span class="line"></span><br><span class="line">session.dataTask(with: url) &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">    <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> error = error &#123;</span><br><span class="line">            completionHandler(.error(error))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">guard</span></span><br><span class="line">            <span class="keyword">let</span> data = data,</span><br><span class="line">            <span class="keyword">let</span> jsonObject = <span class="keyword">try</span>? <span class="type">JSONSerialization</span>.jsonObject(with: data, options: []),</span><br><span class="line">            <span class="keyword">let</span> jsonDict = jsonObject <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>],</span><br><span class="line">            <span class="keyword">let</span> dataDict = jsonDict[<span class="string">"data"</span>] <span class="keyword">as</span>? [<span class="type">String</span>: <span class="type">Any</span>]</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            completionHandler(.error(<span class="type">ServiceError</span>.cannotParse))</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> items = dataDict.values.<span class="built_in">map</span>&#123; $<span class="number">0</span> &#125; <span class="keyword">as</span>? [[<span class="type">String</span>: <span class="type">Any</span>]]</span><br><span class="line">        <span class="keyword">let</span> tickets = items!.compactMap(<span class="type">Ticket</span>.<span class="keyword">init</span>)</span><br><span class="line">        completionHandler(.success(tickets))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;.resume()</span><br></pre></td></tr></table></figure>
<p>It is not a bad idea, if you write a simple example, but it will turn to a disaster quickly when you write a real application. But I don‚Äôt want to use the Alamofire right now. So I followed Malcolm Kumwenda to create my own networking library, base on his codebase, I make a little change to support multi data sources.</p>
<p>The diagram is showed below, there three main roles in this diagram<br><img src="/From-MVC-to-MVVM-C-Step-by-Step/Networking.png" width="80%" margin-left="auto" margin-right="auto"><br></p>
<ol>
<li><p>Different endpoints in every data source are defined in different enums(<strong><em>Huobi API, CoinMarketAPI and CryptoCompareAPI</em></strong>), these enums all conform EndPointType protocol, you can get http parameters, paths and methods from these variables in this protocol, the return values depend on the values of the enums.</p>
</li>
<li><p>Router is a generic class. Giving different EndPoints, we can create different routers. The responsibility of this Router is prepare the parameters depending on the given endpoints, then trigger the real url sessions.</p>
</li>
<li><p>Our application involve three websites: Huobi, CoinMarket and CryptoCompare. So we create three NetworkManagers for each site. These NetworkManagers are all singleton, creating a router using an endpoint to replace the placeholder is their only jobs, then inject this router into themselves. These NetworkManagers all inherit form NetworkManager who handle the errors during the networking requests, and parse the JSON result form backend. It aslo managers all tasks created by the router. You can cancel these tasks by unique id.</p>
</li>
<li><p>NetworkEnvironment is a singleton class which distinguishs different running environment:</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">NetworkEnvironment</span> </span>&#123;</span><br><span class="line">    <span class="keyword">case</span> qa</span><br><span class="line">    <span class="keyword">case</span> product</span><br><span class="line">    <span class="keyword">case</span> staging</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<p>In Swift 4 they provide Decodable protocol, I use this to convert my JSON objects to an equivalent Struct or Class. Sometimes you don‚Äôt need to write a single line, but if the names of the properties in our Classes are different from the keys returning from backend, we need to build the mapping.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//MARK: Listings</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Item</span> </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> id: <span class="type">UInt</span></span><br><span class="line">    <span class="keyword">let</span> name: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> symbol: <span class="type">String</span></span><br><span class="line">    <span class="keyword">let</span> websiteSlug: <span class="type">String</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Item</span>: <span class="title">Decodable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="class"><span class="keyword">enum</span> <span class="title">ItemCodingKeys</span>: <span class="title">String</span>, <span class="title">CodingKey</span> </span>&#123;</span><br><span class="line">        <span class="keyword">case</span> id</span><br><span class="line">        <span class="keyword">case</span> name</span><br><span class="line">        <span class="keyword">case</span> symbol</span><br><span class="line">        <span class="keyword">case</span> websiteSlug = <span class="string">"website_slug"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span>(from decoder: <span class="type">Decoder</span>) <span class="keyword">throws</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> itemContainer = <span class="keyword">try</span> decoder.container(keyedBy: <span class="type">ItemCodingKeys</span>.<span class="keyword">self</span>)</span><br><span class="line"></span><br><span class="line">        id = <span class="keyword">try</span> itemContainer.decode(<span class="type">UInt</span>.<span class="keyword">self</span>, forKey: .id)</span><br><span class="line">        name = <span class="keyword">try</span> itemContainer.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: .name)</span><br><span class="line">        symbol = <span class="keyword">try</span> itemContainer.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: .symbol)</span><br><span class="line">        websiteSlug = <span class="keyword">try</span> itemContainer.decode(<span class="type">String</span>.<span class="keyword">self</span>, forKey: .websiteSlug)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="The-Bridge-Controllers"><a href="#The-Bridge-Controllers" class="headerlink" title="The Bridge - Controllers"></a>The Bridge - Controllers</h2><p>Now we have the two important elements ‚ÄúViews‚Äù and ‚ÄúModels‚Äù in MVC pattern. We will finish our business logics and application logics in our ‚ÄúControllers‚Äù to connect our ‚ÄúViews‚Äù with our ‚ÄúModels‚Äù.</p>
<p>The main feature of this demo application is fetch data from three websites who provide real time exchange infos of cryptocurrencies, and show these data in a tableview. Thee is no business logic at the front end, and this application only contains some simple application logics:</p>
<ol>
<li>Filter the result got from the network by typing some keywords at the top of the tableview.</li>
<li>Choice whether or not to list tokens by clicking a switch of selecting cryptocurrency type.</li>
<li>Sort the list in a descending or ascending order by name or price or change rate.</li>
<li>You can swipe the tableview item in the price view controller to add this cryptocurrency into your favorite list. You can also remove it from your favorite list. This favorite list will be saved, and will be reload when this application is being launched.</li>
<li>When you click the item, the tableview cell will be expanded, and show the kline of the selected cryptocurrency in a chart.</li>
<li>As a demo application, I add a feature that you can select different data sources of this kline in the setting view controller.</li>
<li>It will pop a webview to present the detail information of the selected cryptocurrency, when you tap the ‚Äúeye‚Äù on the right top of the expanded chart view.</li>
</ol>
<p>Writing these application logics is not a big challenge. After I added a few lines of code, I can filter this list by some keywords and type. But when I was adding the sorting logic, I was aware that I had already messed around the view controllers.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> ticker = showCoinOnly ? (whichHeader == .coin ? sortTickers(_tickers.<span class="built_in">filter</span>(&#123; !$<span class="number">0</span>.isToken &#125;))[indexPath.row] : _tickers.<span class="built_in">filter</span>(&#123; !$<span class="number">0</span>.isToken &#125;)[indexPath.row])</span><br><span class="line">    : (indexPath.section == <span class="number">0</span> ? (whichHeader == .coin ? sortTickers(_tickers.<span class="built_in">filter</span>(&#123; !$<span class="number">0</span>.isToken &#125;))[indexPath.row] : _tickers.<span class="built_in">filter</span>(&#123; !$<span class="number">0</span>.isToken &#125;)[indexPath.row])</span><br><span class="line">        : (whichHeader == .token ? sortTickers(_tickers.<span class="built_in">filter</span>(&#123; $<span class="number">0</span>.isToken &#125;))[indexPath.row] : _tickers.<span class="built_in">filter</span>(&#123; $<span class="number">0</span>.isToken &#125;)[indexPath.row]))</span><br></pre></td></tr></table></figure>
<p>But when I wanted to display the result on the tableview, Only three conditions I needed to apply on the result, this expression made me crazy, and I put this snippet in every place in the tableview controller. I realized that this code must be used and can be readable. All of the functions in the above code is filtering and sorting when some conditions is changed.</p>
<p><img src="/From-MVC-to-MVVM-C-Step-by-Step/Data_Filter.png" width="80%" margin-left="auto" margin-right="auto"><br></p>
<p>This diagram is more like some figures in reactive programming article, this is the main motivation why we need to change from functional programming paradigm to imperative mode. Let me finish the MVC part, because we still meet other problems. So I create an extension of Array where its element must be ‚ÄúTicker‚Äù. Then I moved this logic into the ‚Äúmilter‚Äù function in this extension.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Array</span> <span class="title">where</span> <span class="title">Element</span> == <span class="title">Ticker</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">filter</span><span class="params">(BySearch searchText: String?)</span></span> -&gt; [<span class="type">Ticker</span>] &#123;</span><br><span class="line">        <span class="keyword">var</span> filterTickers = [<span class="type">Ticker</span>]()</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">let</span> lowcasedSearchText = searchText?.lowercased() &#123;</span><br><span class="line">            filterTickers = <span class="keyword">self</span>.<span class="built_in">filter</span> &#123; $<span class="number">0</span>.fullName.lowercased().range(of: lowcasedSearchText) != <span class="literal">nil</span> &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> filterTickers.<span class="built_in">count</span> == <span class="number">0</span> &#123;</span><br><span class="line">            filterTickers = <span class="keyword">self</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> filterTickers</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">milter</span><span class="params">(filterBy searchText: String?, separatedBy section: Section, sortedBy condition: Sorting)</span></span> -&gt; [<span class="type">Ticker</span>] &#123;</span><br><span class="line">        <span class="keyword">var</span> filterTickers = [<span class="type">Ticker</span>]()</span><br><span class="line">        filterTickers = <span class="built_in">filter</span>(<span class="type">BySearch</span>: searchText)</span><br><span class="line"></span><br><span class="line">        filterTickers = filterTickers.<span class="built_in">filter</span> &#123;</span><br><span class="line">            <span class="keyword">switch</span> section &#123;</span><br><span class="line">            <span class="keyword">case</span> .coin:</span><br><span class="line">                <span class="keyword">return</span> !$<span class="number">0</span>.isToken</span><br><span class="line">            <span class="keyword">case</span> .token:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.isToken</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> condition == .<span class="keyword">none</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> filterTickers</span><br><span class="line">        &#125;</span><br><span class="line">        filterTickers = filterTickers.sorted &#123;</span><br><span class="line">            <span class="keyword">switch</span> condition &#123;</span><br><span class="line">            <span class="keyword">case</span> .name:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.fullName &lt; $<span class="number">1</span>.fullName</span><br><span class="line">            <span class="keyword">case</span> .nameDesc:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.fullName &gt; $<span class="number">1</span>.fullName</span><br><span class="line">            <span class="keyword">case</span> .change:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.quotes[<span class="string">"USD"</span>]!.percentChange24h &lt; $<span class="number">1</span>.quotes[<span class="string">"USD"</span>]!.percentChange24h</span><br><span class="line">            <span class="keyword">case</span> .changeDesc:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.quotes[<span class="string">"USD"</span>]!.percentChange24h &gt; $<span class="number">1</span>.quotes[<span class="string">"USD"</span>]!.percentChange24h</span><br><span class="line">            <span class="keyword">case</span> .price:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.quotes[<span class="string">"USD"</span>]!.price &lt; $<span class="number">1</span>.quotes[<span class="string">"USD"</span>]!.price</span><br><span class="line">            <span class="keyword">case</span> .priceDesc:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.quotes[<span class="string">"USD"</span>]!.price &gt; $<span class="number">1</span>.quotes[<span class="string">"USD"</span>]!.price</span><br><span class="line">            <span class="keyword">default</span>:</span><br><span class="line">                <span class="keyword">return</span> $<span class="number">0</span>.fullName &lt; $<span class="number">1</span>.fullName</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> filterTickers</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In the tableview delegator or datasource, I replaced the old ones with<br><figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> _tickers = tickers.milter(filterBy: <span class="keyword">self</span>.lowercasedSearchText,</span><br><span class="line">                              separatedBy: <span class="type">Section</span>(section: indexPath.section),</span><br><span class="line">                              sortedBy: _sorted)</span><br></pre></td></tr></table></figure></p>
<p>I cleaned my room, but the story wasn‚Äôt end. The sorting logic start from the user clicking on the section header. There are three section headers, one is for coin type, one is for tokens and the other is for my favorite list. And each of these section has three types of sorting. To keep this sorting statuses, I also introduced lots of ‚ÄúVariables‚Äù to present the status of sorting logic. These code snippet are scattering into several classes. If I didn‚Äôt check the code for some days and reviewed it again, I would almost forgot their relationship with the sorting logic.</p>
<p>The kline chart is embedded in the ExpandViewController, and the ExpandViewController is appeared in two view controllers, one is the price view controller, the other is the Favorite viewcontroller, so the ExpandViewController has two instances. And these instances have different life cycle. We change the kline datasource from the Setting view controller, this change can‚Äôt be conveyed to every one. There is no good method to cache this change, except using a global singleton object to store this status. That is why I created a class called ‚ÄúKLineSource‚Äù. Too many global object means disaster will come. But the MVC model, I have no choice, if I don‚Äôt want to keep this status in a lot of objects, and transfers this status from one object to the other one. It will be more uglily than the method before.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KLineSource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">KLineSource</span>()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> dataSource = <span class="type">DataSource</span>.cryptoCompare</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">init</span>() &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>This is a simple demo application. So I only met these two main barriers. One is how to maintain relative statuses, and connect them effectively, some statuses are changed, some one will follow. Another is how to keep some statuses that we can access them convenience. I work around these issues, the codebase looks uglily now. And I have no idea how to test these code. So far I have finished the application under MVC pattern. You can check the code out here.</p>
<p>I think the MVVM pattern only brings us branch of new classes, if we don‚Äôt introduce the reactive framework. If we separate some logics from the massive view controllers, it will help us to test our application logic, but I am not sure about it is useful. Our real problem is how to synchronize these statuses distributed in different objects. The RxSwift give us a better solution to connect the statuses together. So I will jump to the MVVM w/ RxSwift in the next section. </p>
<h2 id="MVC-RxSwift"><a href="#MVC-RxSwift" class="headerlink" title="MVC-RxSwift"></a>MVC-RxSwift</h2><p><img src="/From-MVC-to-MVVM-C-Step-by-Step/Methods_For_Information_Flow.png" width="80%" margin-left="auto" margin-right="auto"><br><br>When I separate our application into different objects with MVC pattern, we need some methods to exchange informations betwen these objects. In Apple‚Äôs framework, there are seveval ways we can choice, from delegates, callback blocks, notifications, KVO, to target/action event observers. It is convenient for us to glue these objects together. But it is also confused to us. Sometimes how to choice what kind of technology is a challenge. The big problem is we aslo need to connnect these different asynchronization methods in an appropriate way. In this process, we might create more additional varables to keep the status of the applcation. </p>
<p>It‚Äôs time to introduce the RxSwift. In RxSwift, an Obseravble can emit a sequences of event. And this event contains some kind of value. RxSwift also provide lots of operators to convert and combine these events whatever you want. The different kinds of Subjects are powerful tools we can use to bond these sequences to create reactive chains. When we subscribe these sequences, we will get the responses automatically. </p>
<p>Though RxSwift is a powerful tool, but it seems like a totally different language. We need to change our minds to master the new language. And the learning curve of Swift is higher than learning Swift as an Objective-C programmer. Swift and Objective-C are different dialects in a same language. But when we use RxSwift, we just like talking with Alias. There is no shortcut to master the new language. Just use try and use it.</p>
<h4 id="How-to-encapsulate-networking-API-using-RxSwift"><a href="#How-to-encapsulate-networking-API-using-RxSwift" class="headerlink" title="How to encapsulate networking API using RxSwift"></a>How to encapsulate networking API using RxSwift</h4><p>The first thing to me is encapsulating callback methods in networking API with RxSwift Observable. I added a new function called <em>getDataFromEndPointRx</em> to convert the callback into an Observable. And the Observable is a disposable object, I put the cancel logic in a callback function when the disposable object is created. So when the Obseravble object is released, It will cancel the http request automatically. </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDataFromEndPointRx</span>&lt;T: Decodable&gt;<span class="params">(<span class="number">_</span> endPoint: EndPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">                         type: T.<span class="keyword">Type</span>)</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="type">Observable</span>&lt;<span class="type">T</span>&gt;.create(&#123; observer <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> taskKey = <span class="keyword">self</span>.getDataFromEndPoint(endPoint, type: type) &#123;</span><br><span class="line">            (data, error) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">                observer.onError(error!)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> _data = data <span class="keyword">as</span>? <span class="type">T</span> &#123;</span><br><span class="line">                observer.onNext(_data)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="type">Disposables</span>.create &#123;</span><br><span class="line">            <span class="keyword">self</span>.cancelRequestWithUniqueKey(taskKey)</span><br><span class="line">            <span class="keyword">self</span>.tasks.removeValue(forKey: taskKey)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">getDataFromEndPoint</span>&lt;T: Decodable&gt;<span class="params">(<span class="number">_</span> endPoint: EndPoint,</span></span></span><br><span class="line"><span class="function"><span class="params">                                             type: T.<span class="keyword">Type</span>,</span></span></span><br><span class="line"><span class="function"><span class="params">                         networkManagerCompletion: @escaping NetworkManagerCompletion)</span></span> -&gt; taskId &#123;</span><br><span class="line">    <span class="keyword">let</span> task = router.request(endPoint) &#123; (data, response, error) <span class="keyword">in</span></span><br><span class="line">        <span class="type">DispatchQueue</span>.main.async &#123;</span><br><span class="line">            <span class="keyword">if</span> error != <span class="literal">nil</span> &#123;</span><br><span class="line">                networkManagerCompletion(<span class="literal">nil</span>, <span class="type">NetworkResponse</span>.failed)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> response = response <span class="keyword">as</span>? <span class="type">HTTPURLResponse</span> &#123;</span><br><span class="line">                <span class="keyword">let</span> result = <span class="keyword">self</span>.handleNetworkResponse(response)</span><br><span class="line">                <span class="keyword">switch</span> result &#123;</span><br><span class="line">                <span class="keyword">case</span> .success:</span><br><span class="line">                    <span class="keyword">guard</span> <span class="keyword">let</span> responseData = data <span class="keyword">else</span> &#123;</span><br><span class="line">                        networkManagerCompletion(<span class="literal">nil</span>, <span class="type">NetworkResponse</span>.noData)</span><br><span class="line">                        <span class="keyword">return</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">do</span> &#123;</span><br><span class="line">                        <span class="keyword">let</span> apiResponse = <span class="keyword">try</span> <span class="type">JSONDecoder</span>().decode(type.<span class="keyword">self</span>, from: responseData)</span><br><span class="line">                        networkManagerCompletion(apiResponse, <span class="literal">nil</span>)</span><br><span class="line">                    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">                        networkManagerCompletion(<span class="literal">nil</span>, <span class="type">NetworkResponse</span>.unableTODecode)</span><br><span class="line">                    &#125;</span><br><span class="line">                <span class="keyword">default</span>:</span><br><span class="line">                    networkManagerCompletion(<span class="literal">nil</span>, result)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> taskId = <span class="type">NSUUID</span>().uuidString</span><br><span class="line">    tasks = [taskId: task]</span><br><span class="line">    <span class="keyword">return</span> taskId</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>In our application, we use Filesystem APIs to save our favorite cryptocurrencies. The Filesystem APIs are more like our networking APIs. We can use the same methodology to convert the Filesystem APIs into RxSwift Observables. But in this application, I didn‚Äôt do that, the main reason is our saved data is very small, and we can treat these APIs as synchronized function calls. So I think is not necessary for us to encapsulate them. I just subscrible the actions, and call these functions when the actions take place.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">_selectRemoveMyFavorites.subscribe(onNext: &#123;</span><br><span class="line">    <span class="keyword">self</span>.removeSavedJSONFileFromDisk()</span><br><span class="line">&#125;).disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<h4 id="How-to-handle-the-error-events-emmited-from-networking-API-Materialize-and-Dematerialize"><a href="#How-to-handle-the-error-events-emmited-from-networking-API-Materialize-and-Dematerialize" class="headerlink" title="How to handle the error events emmited from networking API, Materialize and Dematerialize"></a>How to handle the error events emmited from networking API, Materialize and Dematerialize</h4><p>Our networking APIs have not the ability to handle the errors, they just conduct these errors from the bottom to the applcation layer. How to handle these errors is depended on uour application logic. Without RxSwift, every thing is ok. But when we convert the callback function into Observable onject, the chain will be broken, because I send the errors through the onError event. After the onError event is sent, the Observable object will be terminated, this is not we want, but we still want to get these error messages in the application layer. How can we get them? In RxSwift, they provide a mechanism called <em>Materialize</em>. It add a shell on the onError event, then this event turns into a normal event, and the error event become a value inside the normal event. Then we can use a filter operator to catch the error event when it happans. If it is not a error event, then the filter will <em>dematerialize</em> the event, we will get the original data again.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">huobiReload.withLatestFrom(symbol.asObservable())</span><br><span class="line">    &#123; (dataSource, symbol) <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> symbol</span><br><span class="line">    &#125;</span><br><span class="line">    .flatMap &#123; (symbol) -&gt;  <span class="type">Observable</span>&lt;<span class="type">Event</span>&lt;<span class="type">KlineResponse</span>&gt;&gt; <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> <span class="type">HuobiNetworkManager</span>.shared.getDataFromEndPointRx(.historyKline(symbol: symbol.lowercased() + <span class="string">"usdt"</span>, period: <span class="string">"5min"</span>, size: <span class="number">150</span>), type: <span class="type">KlineResponse</span>.<span class="keyword">self</span>).materialize()</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="built_in">filter</span> &#123; [<span class="keyword">unowned</span> <span class="keyword">self</span> ] <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">guard</span> $<span class="number">0</span>.error == <span class="literal">nil</span> <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="type">Log</span>.e(<span class="string">"Catch Error: +\($0.error!)"</span>)</span><br><span class="line">            <span class="keyword">self</span>.histoHourVolumes = <span class="type">Variable</span>&lt;[<span class="type">OHLCV</span>]&gt;([])</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    .dematerialize()</span><br><span class="line">    .<span class="built_in">map</span> &#123; (kLineResponse) -&gt; [<span class="type">KlineItem</span>] <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">return</span> kLineResponse.data</span><br><span class="line">    &#125;</span><br><span class="line">    .<span class="built_in">map</span> &#123; (kLineItems) -&gt; [<span class="type">OHLCV</span>] <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">var</span> ohlcvs = [<span class="type">OHLCV</span>]()</span><br><span class="line">        kLineItems.forEach(&#123; (kLineItem) <span class="keyword">in</span></span><br><span class="line">            <span class="keyword">let</span> ohlcv = <span class="type">OHLCV</span>(time: <span class="number">0</span>, <span class="keyword">open</span>: kLineItem.<span class="keyword">open</span>!, close: kLineItem.close!, low: kLineItem.low!, high: kLineItem.high!, volumefrom: <span class="number">0.0</span>, volumeto: <span class="number">0.0</span>)</span><br><span class="line">            ohlcvs.append(ohlcv)</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">return</span> ohlcvs</span><br><span class="line">    &#125;</span><br><span class="line">    .bind(to: histoHourVolumes)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>The Houbi API need me to provide correct symbol name, but I get the symbol name of cryptocurrency from CoinMarket. Sometimes the names of these symbols are not One-to-one correspondence. In this demo application, I don‚Äôt want to handle this situation, So i will get an error return from the Huobi API, when I switch from CryptoCompare to the Huobi API. </p>
<h4 id="Use-RxSwift-Extensions-RxDataSource"><a href="#Use-RxSwift-Extensions-RxDataSource" class="headerlink" title="Use RxSwift Extensions: RxDataSource"></a>Use RxSwift Extensions: RxDataSource</h4><p>Now we get the data, we can bind these data to views. RxCocoa has already encapsulated lots of controls in UIKit, but it is not enough when we encount some complex controls like TableView or CollectionView. At this situation, we need to use the extension framework from RxSwift community. RxDataSource makes us work more easy. First we create a datasource which is comfirmed SectionModelType protocol. This datasource also define a callback how to config tableview cell when we get the datasource item.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">dataSource = <span class="type">RxTableViewSectionedReloadDataSource</span>&lt;<span class="type">SectionModel</span>&lt;<span class="type">String</span>, <span class="type">Ticker</span>&gt;&gt;(</span><br><span class="line">    configureCell: &#123; dataSource, tableView, indexPath, item <span class="keyword">in</span></span><br><span class="line">        <span class="keyword">let</span> cell = tableView.dequeueReusableCell(withIdentifier: <span class="keyword">self</span>.cellIdentifier, <span class="keyword">for</span>: indexPath) <span class="keyword">as</span>! <span class="type">CurrencyCell</span></span><br><span class="line">        cell.selectionStyle = .<span class="keyword">none</span></span><br><span class="line">        cell.setCoinImage(item.imageUrl, with: (<span class="keyword">self</span>.baseImageUrl)!)</span><br><span class="line">        cell.setName(item.fullName)</span><br><span class="line">        cell.setPrice((item.quotes[<span class="string">"USD"</span>]?.price)!)</span><br><span class="line">        cell.setChange((item.quotes[<span class="string">"USD"</span>]?.percentChange24h)!)</span><br><span class="line">        cell.setVolume24h((item.quotes[<span class="string">"USD"</span>]?.volume24h)!)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">self</span>.currentUrlString = (<span class="keyword">self</span>.baseImageUrl)! + item.url</span><br><span class="line">        </span><br><span class="line">        cell.setWithExpand(<span class="keyword">self</span>.expandedIndexPaths.<span class="built_in">contains</span>(indexPath))</span><br></pre></td></tr></table></figure>
<p>After we get the data from Observable of the networking API, we map the event from the [Ticker] to [SectionModel&lt;String, Ticker&gt;], and bind this sections into the tableview. The RxDataSource solved our multi sections problem. </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Observable</span>.combineLatest(_coins, __tokens) &#123;</span><br><span class="line">    <span class="keyword">return</span> ($<span class="number">0</span>, $<span class="number">1</span>)</span><br><span class="line">&#125;</span><br><span class="line">.<span class="built_in">map</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> sections = [<span class="type">SectionModel</span>&lt;<span class="type">String</span>, <span class="type">Ticker</span>&gt;]()</span><br><span class="line">    <span class="keyword">if</span> $<span class="number">0</span>.<span class="built_in">count</span> != <span class="number">0</span> &#123;</span><br><span class="line">        sections.append(<span class="type">SectionModel</span>(model: <span class="string">"Coin"</span>, items: $<span class="number">0</span>))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> $<span class="number">1</span>.<span class="built_in">count</span> != <span class="number">0</span> &#123;</span><br><span class="line">        sections.append(<span class="type">SectionModel</span>(model: <span class="string">"Token"</span>, items: $<span class="number">1</span>))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> sections</span><br><span class="line">&#125;</span><br><span class="line">.bind(to: tableView.rx.items(dataSource: dataSource!))</span><br><span class="line">.disposed(by: disposeBag)</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="type">But</span> <span class="type">I</span> can not <span class="built_in">find</span> how to customize the section header view <span class="keyword">in</span> different sections. <span class="type">The</span> <span class="type">RxSwift</span> keeps the delegate solution <span class="keyword">for</span> some situation it can't handle. <span class="type">We</span> can <span class="keyword">set</span> a delegate to a tableview.rx, then the tableview still will call our delegate function <span class="keyword">in</span> the view controller. </span><br><span class="line"></span><br><span class="line">``` <span class="type">Swift</span></span><br><span class="line">dataSource?.canEditRowAtIndexPath = &#123; dataSource, indexPath <span class="keyword">in</span></span><br><span class="line">    <span class="keyword">return</span> !<span class="keyword">self</span>.expandedIndexPaths.<span class="built_in">contains</span>(indexPath <span class="keyword">as</span> <span class="type">IndexPath</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tableView.rx</span><br><span class="line">    .setDelegate(<span class="keyword">self</span>)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">PricesViewController</span> </span>&#123;    </span><br><span class="line">    <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, editActionsForRowAt indexPath: IndexPath)</span></span> -&gt; [<span class="type">UITableViewRowAction</span>]? &#123;</span><br><span class="line">        <span class="keyword">let</span> favoriteRowAction = <span class="type">UITableViewRowAction</span>(style: <span class="type">UITableViewRowAction</span>.<span class="type">Style</span>.<span class="keyword">default</span>, title: <span class="string">"Favorite"</span>, handler:&#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] action, indexpath <span class="keyword">in</span></span><br><span class="line">            </span><br><span class="line">            <span class="keyword">guard</span> <span class="keyword">let</span> ticker = <span class="keyword">self</span>?.dataSource?[indexPath] <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">self</span>?.favoritesViewController.baseImageUrl = <span class="keyword">self</span>?.baseImageUrl</span><br><span class="line">            <span class="keyword">self</span>?.favoritesViewController.addTicker(ticker)</span><br><span class="line">        &#125;)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> [favoriteRowAction]</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">tableView</span><span class="params">(<span class="number">_</span> tableView: UITableView, viewForHeaderInSection section: Int)</span></span> -&gt; <span class="type">UIView</span>? &#123;</span><br><span class="line">        <span class="keyword">if</span> section == <span class="number">0</span> &amp;&amp; <span class="keyword">self</span>.coinSectionHeaderView == <span class="literal">nil</span> || section == <span class="number">1</span> &amp;&amp; <span class="keyword">self</span>.tokenSectionHeaderView == <span class="literal">nil</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">let</span> headerView = <span class="keyword">super</span>.tableView(tableView, viewForHeaderInSection: section) <span class="keyword">as</span>? <span class="type">SectionHeaderView</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> section == <span class="number">0</span> &#123;</span><br><span class="line">                    headerView.section = <span class="type">SortSection</span>.coin</span><br><span class="line">                    <span class="keyword">self</span>.coinSectionHeaderView = headerView</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    headerView.section = <span class="type">SortSection</span>.token</span><br><span class="line">                    <span class="keyword">self</span>.tokenSectionHeaderView = headerView</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">return</span> headerView</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.coinSectionHeaderView</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> section == <span class="number">0</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.coinSectionHeaderView</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">self</span>.tokenSectionHeaderView</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Connect-all-Observables-and-Observers-together"><a href="#Connect-all-Observables-and-Observers-together" class="headerlink" title="Connect all Observables and Observers together"></a>Connect all Observables and Observers together</h4><p>Distinguishing from the MVC pattern, we connect all of the Observables and Observers together and gather all application logics like filtering, sorting and separating, etc in one place. I drew a whole diagram of these logics to show how different it is between using RxSwift and the MVC model.<br><img src="/From-MVC-to-MVVM-C-Step-by-Step/RxSwift_Chain.png" width="100%" margin-left="auto" margin-right="auto"><br></p>
<p>In same cases, I use <em>filter</em> operator to activate different path in the reactive chain. And using <em>withLatestFrom</em> operator to tigger one event by the other event. Changing Kline datasource is an event emitted from a segment control in the Setting ViewController, and showing the Kline need another event which is changing the symbol name. The <em>changing datasource event</em> will trigger the <em>changing symbol name</em> event. </p>
<p><img src="/From-MVC-to-MVVM-C-Step-by-Step/RxSwift_Chain_2.png" width="100%" margin-left="auto" margin-right="auto"><br></p>
<h4 id="Interaction-between-view-controllers-from-delegate-to-obserable-and-observer"><a href="#Interaction-between-view-controllers-from-delegate-to-obserable-and-observer" class="headerlink" title="Interaction between view controllers from delegate to obserable and observer"></a>Interaction between view controllers from delegate to obserable and observer</h4><p>After I established the reactive chains to replace the delegates in the view controllers, I deleted some of properties who refer to the data models in the Price View Controler and Favorite View Controller. And I don‚Äôt need to keep the intermedia statuses for the appplication logics, but It doesn‚Äôt mean we can remove all statuses, these statuses are useful in exchanging informations between view controllers. If the object owned by the view controller, I think you can use the Observable in the object through the property directly. But most of time, I need to create a stub in the target view controller like the Price View Controller, and bind this stub with the Observable in the source view controller like the Setting ViewController. When the SettingViewController is removed from the memory, the Variable showCoinOnly will be disconnected from its source and sleep. When the SettingViewController is created again, the connection will be rebuilt, and the showCoinOnly will resend the event from the SettingViewController to the filtering logic chain as a router.</p>
<p><img src="/From-MVC-to-MVVM-C-Step-by-Step/RxSwift_Chain_3.png" width="100%" margin-left="auto" margin-right="auto"><br></p>
<p>In this diagram, you can see I create a two way bind in the SettingViewCOntroller, the showCoinOnly in the PriceViewController will keep the status, when the SettingViewController is created again, the Switch will get the status again. But how to write a 2-way bind is confusing me, I just wrote the code below, but I don‚Äôt know why it didn‚Äôt cause the infinitive problem.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">showCoinOnlySwitch.rx.isOn.changed.debug()</span><br><span class="line">    .bind(to: _selectShowCoinOnly)</span><br><span class="line">    .disposed(by: disposeBag)</span><br><span class="line"></span><br><span class="line">didSelectShowCoinOnly.debug()</span><br><span class="line">    .bind(to: showCoinOnlySwitch.rx.isOn)</span><br><span class="line">    .disposed(by: disposeBag)</span><br></pre></td></tr></table></figure>
<p>And if you want to use 2-way bind in other place, you can create a generic funtion to handle this. </p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">infix</span> <span class="keyword">operator</span> &lt;-&gt;</span><br><span class="line"></span><br><span class="line">@discardableResult <span class="function"><span class="keyword">func</span> &lt;-&gt;&lt;T&gt;<span class="params">(property: ControlProperty&lt;T&gt;, variable: Variable&lt;T&gt;)</span></span> -&gt; <span class="type">Disposable</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> variableToProperty = variable.asObservable()</span><br><span class="line">        .bind(to: property)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> propertyToVariable = property</span><br><span class="line">        .subscribe(</span><br><span class="line">            onNext: &#123; variable.value = $<span class="number">0</span> &#125;,</span><br><span class="line">            onCompleted: &#123; variableToProperty.dispose() &#125;</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="type">Disposables</span>.create(variableToProperty, propertyToVariable)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="The-Problems-I-met"><a href="#The-Problems-I-met" class="headerlink" title="The Problems I met"></a>The Problems I met</h4><h5 id="The-scope-of-a-status"><a href="#The-scope-of-a-status" class="headerlink" title="The scope of a status"></a>The scope of a status</h5><p>When I implement the application logic, I realize that there are three kinds of status I need to mantain. </p>
<ol>
<li>Local Status<br>To be honest there is no local status when we use the RxSwift, the RxSwift doesn‚Äôt keep the status, it just trigger events from the Observables and consume these events by the Observers. I use this terminology in order to distingush the other two statuses. </li>
<li>Status as a property<br>Just like I discuss in the last section, the showCoinOnly in the PriceViewCOntroller keep the status transfered from the SettingViewController. This Variable will share information between two view controllers, one will be released, the other is alway keeping in the memory. In this case I keep the status in the PriceViewcontroller, because, the PriceVIewController will not be released in the application whole life time.</li>
<li>Global status<br>But sometimes the two controllers who share inforamtion will all be released. So how can I keep the status like the KLineSource in this application. The KLineSource is produced from the SeetingViewController when a user select the datasource on the segment control, and the KLineSource si consumed by the ExpandViewController to determine which APIs will be called. But these two view controllers will be release at runtime. So where can I keep the status. In this demo example I create a singleton global object to keep this status called KLineSource. </li>
</ol>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KLineSource</span> </span>&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">let</span> shared = <span class="type">KLineSource</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">var</span> dataSource = <span class="type">Variable</span>&lt;<span class="type">DataSource</span>&gt;(<span class="type">DataSource</span>.cryptoCompare)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">init</span>() &#123;</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h5 id="How-to-initialize-the-RxSwift-reactive-chain-when-some-of-these-view-controllers-are-created-dynamically"><a href="#How-to-initialize-the-RxSwift-reactive-chain-when-some-of-these-view-controllers-are-created-dynamically" class="headerlink" title="How to initialize the RxSwift reactive chain when some of these view controllers are created dynamically"></a>How to initialize the RxSwift reactive chain when some of these view controllers are created dynamically</h5><p>Because some of these view controllers will be created dynamically, it bring<br>another problem what is the appropriate time to create a view controller, and when to bind the reaction chain. When we create a view controller and send a event to its Observer, it won‚Äôt get this event if it hasn‚Äôt band the the Observer first.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">prepare</span><span class="params">(<span class="keyword">for</span> segue: UIStoryboardSegue, sender: Any?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.prepare(<span class="keyword">for</span>: segue, sender: sender)</span><br><span class="line">    segue.destination.transitioningDelegate = <span class="keyword">self</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">let</span> navigationController = segue.destination <span class="keyword">as</span>? <span class="type">SettingsNavigationController</span>,</span><br><span class="line">        <span class="keyword">let</span> settingsViewController = navigationController.viewControllers.first <span class="keyword">as</span>? <span class="type">SettingsViewController</span> &#123;</span><br><span class="line"></span><br><span class="line">        settingsViewController.didSelectShowCoinOnly</span><br><span class="line">            .bind(to: showCoinOnly)</span><br><span class="line">            .disposed(by: disposeBag)</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// FIXED: How to save the status</span></span><br><span class="line">        settingsViewController._selectShowCoinOnly.onNext(showCoinOnly.value)</span><br></pre></td></tr></table></figure>
<p>When the seague is triggered, the SettingViewControler will be created, and I will send the ShowCoinOnly status to the SettingViewController. But if I put the binding code in the ViewDidLoad() in the SettingViewController, this event will be discarded because when the event is being sent, the chain hasn‚Äôt been setup yet. So I need to move the setup logic into awakeFromNib(). And I also need to load the view objects first compulsively like the code below.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">awakeFromNib</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.awakeFromNib()</span><br><span class="line">    <span class="comment">// FIXED: How to save the status..., force load view</span></span><br><span class="line">    <span class="number">_</span> = <span class="keyword">self</span>.view</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">let</span> closeButton = <span class="type">UIBarButtonItem</span>(title: <span class="string">"Close"</span>, style: .plain, target: <span class="keyword">self</span>, action: <span class="literal">nil</span>)</span><br><span class="line">    <span class="keyword">self</span>.navigationItem.leftBarButtonItem = closeButton</span><br><span class="line">    </span><br><span class="line">    dataSourceSegment.selectedSegmentIndex = <span class="type">KLineSource</span>.shared.dataSource.value.rawValue</span><br><span class="line">    </span><br><span class="line">    setupBindings()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">viewDidLoad</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.viewDidLoad()</span><br><span class="line">&#125;</span><br><span class="line">``` </span><br><span class="line"></span><br><span class="line"><span class="type">It</span> <span class="keyword">is</span> not very comfortable, <span class="type">I</span> didn't <span class="built_in">find</span> any other good solution before we use the coordinator. <span class="type">One</span> resposibilty of the coordinator <span class="keyword">is</span> maintaining the lifecycle of <span class="type">ViewModels</span> and the <span class="type">Controllers</span>. <span class="type">It</span> will be a solution to fix this issue. <span class="type">But</span> before we jump to the <span class="type">MVVM</span>-<span class="type">RxSwit</span>-<span class="type">Coordinator</span>, we must create the <span class="type">ViewModel</span> layer first.</span><br><span class="line"></span><br><span class="line">## <span class="type">Create</span> the <span class="type">ViewModels</span></span><br><span class="line"><span class="type">View</span> <span class="type">Models</span> are extracted from view controllers. <span class="type">The</span> process of building the view models <span class="keyword">is</span> separating our application logics from view controllers. <span class="type">The</span> view controller only keep the resposibilities <span class="keyword">for</span> </span><br><span class="line"><span class="number">1</span>. maintain lifecycle of it's views</span><br><span class="line"><span class="number">2</span>. create a view model</span><br><span class="line"><span class="number">3</span>. connect inputs and outputs of the view model to the view elements</span><br><span class="line">   </span><br><span class="line">&lt;img src=<span class="string">"/From-MVC-to-MVVM-C-Step-by-Step/MCVMVMV.gif"</span> width=<span class="string">"100%"</span> margin-<span class="keyword">left</span>=<span class="string">"auto"</span> margin-<span class="keyword">right</span>=<span class="string">"auto"</span>&gt;&lt;br&gt;   </span><br><span class="line">   </span><br><span class="line"><span class="type">View</span> models are not depending on view controllers. <span class="type">They</span> only include application logics, so they are easy to be tested.</span><br><span class="line"></span><br><span class="line"><span class="type">One</span> typical view model <span class="keyword">in</span> our demo <span class="keyword">is</span> the <span class="type">SettingViewModel</span>.</span><br><span class="line"></span><br><span class="line">``` <span class="type">Swift</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SettingViewModel</span> </span>&#123;</span><br><span class="line">    <span class="comment">// MARK: - Inputs</span></span><br><span class="line">    <span class="keyword">let</span> selectDataSource: <span class="type">AnyObserver</span>&lt;<span class="type">DataSource</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> selectShowCoinOnly: <span class="type">AnyObserver</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> removeMyFavorites: <span class="type">AnyObserver</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> cancel: <span class="type">AnyObserver</span>&lt;<span class="type">Void</span>&gt;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - Status</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// MARK: - Outputs</span></span><br><span class="line">    <span class="keyword">let</span> didSelectDataSource : <span class="type">Observable</span>&lt;<span class="type">DataSource</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> didSelectShowCoinOnly: <span class="type">Observable</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> didRemoveMyFavorites: <span class="type">Observable</span>&lt;<span class="type">Bool</span>&gt;</span><br><span class="line">    <span class="keyword">let</span> didCancel: <span class="type">Observable</span>&lt;<span class="type">Void</span>&gt;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">init</span>() &#123;</span><br><span class="line">        <span class="keyword">let</span> _selectShowCoinOnly = <span class="type">BehaviorSubject</span>&lt;<span class="type">Bool</span>&gt;(value: <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">self</span>.selectShowCoinOnly = _selectShowCoinOnly.asObserver()</span><br><span class="line">        <span class="keyword">self</span>.didSelectShowCoinOnly = _selectShowCoinOnly.asObservable()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> _removeMyFavorites = <span class="type">PublishSubject</span>&lt;<span class="type">Bool</span>&gt;()</span><br><span class="line">        <span class="keyword">self</span>.removeMyFavorites = _removeMyFavorites.asObserver()</span><br><span class="line">        <span class="keyword">self</span>.didRemoveMyFavorites = _removeMyFavorites.asObservable()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> _cancel = <span class="type">PublishSubject</span>&lt;<span class="type">Void</span>&gt;()</span><br><span class="line">        <span class="keyword">self</span>.cancel = _cancel.asObserver()</span><br><span class="line">        <span class="keyword">self</span>.didCancel = _cancel.asObservable()</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">let</span> _selectDataSource = <span class="type">BehaviorSubject</span>&lt;<span class="type">DataSource</span>&gt;(value: <span class="type">DataSource</span>.cryptoCompare)</span><br><span class="line">        <span class="keyword">self</span>.selectDataSource = _selectDataSource.asObserver()</span><br><span class="line">        <span class="keyword">self</span>.didSelectDataSource = _selectDataSource.asObservable()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>We don‚Äôt have the coordinator yet, so the SettingViewController is still responsable for creating it‚Äôs view model and connecting the inputs and outputs of the view model to some view controls and inputs and outputs of other view controllers.</p>
<p>If we take a picture of the SettingViewModel, we can get the diagram below:</p>
<p><img src="/From-MVC-to-MVVM-C-Step-by-Step/ViewModel2.png" width="100%" margin-left="auto" margin-right="auto"><br> </p>
<p>In this diagram, you can see the main logic on the client side is included in the PriceViewModel. This view model is just one class, and rely on any other views and view controllers. So we can write a test for it easily. </p>
<h2 id="The-Fininal-Step-Build-a-coordinator-tree"><a href="#The-Fininal-Step-Build-a-coordinator-tree" class="headerlink" title="The Fininal Step, Build a coordinator tree."></a>The Fininal Step, Build a coordinator tree.</h2><p>I call it as a coordinator tree, because, all of our coordinators which corresponds their view controllers, and have parent-children relationship like view controllers. </p>
<p>The top node of this tree is the AppCoordinator, it contains two coordinators, one is PriceCoordinator and the other FavoriteCoordinator.</p>
<p>All coordinators are inherited from BaseCoordinator. The main job of a coordinator is </p>
<ol>
<li>create a view model </li>
<li>ceeate a view controller</li>
<li>inject the view model into the view controller</li>
<li>maintain the navigation between view controllers.</li>
</ol>
<p>The fourth one can be separated some sub-steps</p>
<ol>
<li>creat a target coordinator as an observable object</li>
<li>flatmap some of source coordinator obserable into the target observable, this process is most like calling a networking service. </li>
<li>bind the source coordinator input onto the target coordinator, so we can get the result from the target coordinator. </li>
</ol>
<p>The whole process looks like calling a asynchronization function, when we start a new coordinator. Every coordinator must comfirm the start() function. In this funtion the coordinator returns an Observable object for it‚Äôs source coordinator.</p>
<figure class="highlight swift"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">start</span><span class="params">()</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">Void</span>&gt; &#123;</span><br><span class="line">       <span class="keyword">let</span> navigationViewController0 = rootViewController.viewControllers![<span class="number">0</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span></span><br><span class="line">       <span class="keyword">let</span> viewController = navigationViewController0.viewControllers[<span class="number">0</span>] <span class="keyword">as</span>! <span class="type">PricesViewController</span></span><br><span class="line">       </span><br><span class="line">       <span class="keyword">let</span> navigationViewController1 = rootViewController.viewControllers![<span class="number">1</span>] <span class="keyword">as</span>! <span class="type">UINavigationController</span></span><br><span class="line">       <span class="keyword">let</span> favoritesViewController = navigationViewController1.viewControllers[<span class="number">0</span>] <span class="keyword">as</span>? <span class="type">FavoritesViewController</span></span><br><span class="line">       </span><br><span class="line">       <span class="keyword">let</span> viewModel = <span class="type">PriceViewModel</span>()</span><br><span class="line">       viewController.viewModel = viewModel</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">let</span> showSettings = viewModel.showSettings</span><br><span class="line">           .flatMap &#123; [<span class="keyword">weak</span> <span class="keyword">self</span>] <span class="number">_</span> -&gt; <span class="type">Observable</span>&lt;<span class="type">SettingCoordinationResult</span>&gt; <span class="keyword">in</span></span><br><span class="line">               <span class="keyword">guard</span> <span class="keyword">let</span> `<span class="keyword">self</span>` = <span class="keyword">self</span> <span class="keyword">else</span> &#123; <span class="keyword">return</span> .empty() &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="keyword">self</span>.showSettings(on: viewController, with: viewModel)</span><br><span class="line">           &#125;.share()</span><br><span class="line">       </span><br><span class="line">       showSettings</span><br><span class="line">           .<span class="built_in">filter</span>(&#123;</span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">case</span> .kLineDataSource = $<span class="number">0</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">           &#125;)</span><br><span class="line">           .<span class="built_in">map</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">case</span> .kLineDataSource(<span class="keyword">let</span> value) = $<span class="number">0</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> value</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="type">DataSource</span>.cryptoCompare</span><br><span class="line">           &#125;</span><br><span class="line">           .bind(to: <span class="type">GlobalStatus</span>.shared.klineDataSource)</span><br><span class="line">           .disposed(by: disposeBag)</span><br><span class="line">           </span><br><span class="line">       showSettings</span><br><span class="line">           .<span class="built_in">filter</span>(&#123;</span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">case</span> .showCoinOnly = $<span class="number">0</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">           &#125;)</span><br><span class="line">           .<span class="built_in">map</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">case</span> .showCoinOnly(<span class="keyword">let</span> value) = $<span class="number">0</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> value</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">           &#125;</span><br><span class="line">           .bind(to: viewModel.showCoinOnly)</span><br><span class="line">           .disposed(by: disposeBag)</span><br><span class="line">       </span><br><span class="line">       showSettings</span><br><span class="line">           .<span class="built_in">filter</span>(&#123;</span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">case</span> .removeMyFavorites = $<span class="number">0</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">           &#125;)</span><br><span class="line">           .<span class="built_in">map</span> &#123;</span><br><span class="line">               <span class="keyword">if</span> <span class="keyword">case</span> .removeMyFavorites(<span class="keyword">let</span> value) = $<span class="number">0</span> &#123;</span><br><span class="line">                   <span class="keyword">return</span> value</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">           &#125;</span><br><span class="line">           .bind(to: (favoritesViewController?.viewModel.deleteFavoriteList)!)</span><br><span class="line">           .disposed(by: disposeBag)</span><br><span class="line">       </span><br><span class="line">       </span><br><span class="line">       window.makeKeyAndVisible()</span><br><span class="line">       </span><br><span class="line">       <span class="keyword">return</span> <span class="type">Observable</span>.never()</span><br><span class="line">   &#125;</span><br><span class="line">   </span><br><span class="line">   <span class="keyword">private</span> <span class="function"><span class="keyword">func</span> <span class="title">showSettings</span><span class="params">(on rootViewController: UIViewController, with rootViewModel: PriceViewModel)</span></span> -&gt; <span class="type">Observable</span>&lt;<span class="type">SettingCoordinationResult</span>&gt; &#123;</span><br><span class="line">       <span class="keyword">let</span> settingsCoordinator = <span class="type">SettingCoordinator</span>(rootViewController: rootViewController, rootViewModel: rootViewModel)</span><br><span class="line">       <span class="keyword">return</span> coordinate(to: settingsCoordinator)</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>The relationship between these objects is showed in the figure below:</p>
<p><img src="/From-MVC-to-MVVM-C-Step-by-Step/Coordinator_ Asynchronous_Call.png" width="100%" margin-left="auto" margin-right="auto"><br> </p>
<p>So far we have finished our demo example. It is not a real project, but it is also not very simple. I show you how to refactor the code from MVC pattern to MVVM-Coordinator pattern. And this example also includes some key points to write a iOS application, such as networking service, autolayout, ‚Ä¶</p>
<p>I hope it is helpful for the newbs in iOS develepment.</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/iOS/" rel="tag"># iOS</a>
          
            <a href="/tags/MVC/" rel="tag"># MVC</a>
          
            <a href="/tags/MVVM/" rel="tag"># MVVM</a>
          
            <a href="/tags/RxSwift/" rel="tag"># RxSwift</a>
          
            <a href="/tags/Coordinator/" rel="tag"># Coordinator</a>
          
            <a href="/tags/Design-Pattern/" rel="tag"># Design Pattern</a>
          
            <a href="/tags/Architecture-Pattern/" rel="tag"># Architecture Pattern</a>
          
            <a href="/tags/ViewModel/" rel="tag"># ViewModel</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/What‚Äôs-it-like-to-ride-in-a-self-driving-car/" rel="next" title="What‚Äôs it like to ride in a self-driving car?">
                <i class="fa fa-chevron-left"></i> What‚Äôs it like to ride in a self-driving car?
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/Setup-Webpack-from-Scratch/" rel="prev" title="Setup Webpack from Scratch">
                Setup Webpack from Scratch <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            Table of Contents
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            Overview
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <p class="site-author-name" itemprop="name">Qubo Qin</p>
              <p class="site-description motion-element" itemprop="description"></p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">6</span>
                  <span class="site-state-item-name">posts</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">5</span>
                  <span class="site-state-item-name">categories</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">32</span>
                  <span class="site-state-item-name">tags</span>
                </a>
              </div>
            

          </nav>

          

          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Table-of-Contents"><span class="nav-number">1.</span> <span class="nav-text">Table of Contents</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#Preface"><span class="nav-number">1.1.</span> <span class="nav-text">Preface</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Introduction-of-the-Demo-application"><span class="nav-number">1.2.</span> <span class="nav-text">Introduction of the Demo application</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Design-Our-UI"><span class="nav-number">1.3.</span> <span class="nav-text">Design Our UI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Storyboard-or-Programmatic-is-a-problem"><span class="nav-number">1.3.0.1.</span> <span class="nav-text">Storyboard or Programmatic is a problem</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#How-many-view-controllers-do-we-need"><span class="nav-number">1.3.0.2.</span> <span class="nav-text">How many view controllers do we need?</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AutoLayout-and-constraint"><span class="nav-number">1.3.0.3.</span> <span class="nav-text">AutoLayout and constraint</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#A-good-example-of-changing-the-local-constraints"><span class="nav-number">1.3.0.3.1.</span> <span class="nav-text">A good example of changing the local constraints</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Change-constraints-with-animations"><span class="nav-number">1.3.0.3.2.</span> <span class="nav-text">Change constraints with animations</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#StackView-with-Fill-Distribution"><span class="nav-number">1.3.0.3.3.</span> <span class="nav-text">StackView with Fill Distribution</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Core-Animation‚Äôs-models-classes-and-blocks"><span class="nav-number">1.3.0.4.</span> <span class="nav-text">Core Animation‚Äôs models, classes and blocks</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#View-Animation"><span class="nav-number">1.3.0.4.1.</span> <span class="nav-text">View Animation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Implicit-Layer-Animation"><span class="nav-number">1.3.0.4.2.</span> <span class="nav-text">Implicit Layer Animation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Core-Animation"><span class="nav-number">1.3.0.4.3.</span> <span class="nav-text">Core Animation</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Transitions"><span class="nav-number">1.3.0.4.4.</span> <span class="nav-text">Transitions</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Custom-UIViewController-Transitions"><span class="nav-number">1.3.0.5.</span> <span class="nav-text">Custom UIViewController Transitions</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Add-Gesture-On-the-Section-header"><span class="nav-number">1.3.0.6.</span> <span class="nav-text">Add Gesture On the Section header</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Connect-with-internet"><span class="nav-number">1.4.</span> <span class="nav-text">Connect with internet</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Bridge-Controllers"><span class="nav-number">1.5.</span> <span class="nav-text">The Bridge - Controllers</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#MVC-RxSwift"><span class="nav-number">1.6.</span> <span class="nav-text">MVC-RxSwift</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#How-to-encapsulate-networking-API-using-RxSwift"><span class="nav-number">1.6.0.1.</span> <span class="nav-text">How to encapsulate networking API using RxSwift</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#How-to-handle-the-error-events-emmited-from-networking-API-Materialize-and-Dematerialize"><span class="nav-number">1.6.0.2.</span> <span class="nav-text">How to handle the error events emmited from networking API, Materialize and Dematerialize</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Use-RxSwift-Extensions-RxDataSource"><span class="nav-number">1.6.0.3.</span> <span class="nav-text">Use RxSwift Extensions: RxDataSource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Connect-all-Observables-and-Observers-together"><span class="nav-number">1.6.0.4.</span> <span class="nav-text">Connect all Observables and Observers together</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Interaction-between-view-controllers-from-delegate-to-obserable-and-observer"><span class="nav-number">1.6.0.5.</span> <span class="nav-text">Interaction between view controllers from delegate to obserable and observer</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#The-Problems-I-met"><span class="nav-number">1.6.0.6.</span> <span class="nav-text">The Problems I met</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#The-scope-of-a-status"><span class="nav-number">1.6.0.6.1.</span> <span class="nav-text">The scope of a status</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#How-to-initialize-the-RxSwift-reactive-chain-when-some-of-these-view-controllers-are-created-dynamically"><span class="nav-number">1.6.0.6.2.</span> <span class="nav-text">How to initialize the RxSwift reactive chain when some of these view controllers are created dynamically</span></a></li></ol></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#The-Fininal-Step-Build-a-coordinator-tree"><span class="nav-number">1.7.</span> <span class="nav-text">The Fininal Step, Build a coordinator tree.</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Qubo Qin</span>

  
</div>


  <div class="powered-by">Powered by <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a></div>



  <script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  <span id="busuanzi_container_site_pv">ÊÄªËÆøÈóÆÈáè<span id="busuanzi_value_site_pv"></span>Ê¨°</span>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_uv">ÊÄªËÆøÂÆ¢<span id="busuanzi_value_site_uv"></span>‰∫∫</span>
  <span class="post-meta-divider">|</span>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">Theme &mdash; <a class="theme-link" target="_blank" href="https://github.com/iissnan/hexo-theme-next">NexT.Pisces</a> v5.1.4</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  





  

  

  

  
  

  

  

  

</body>
</html>
